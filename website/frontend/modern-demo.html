<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Companion - Web Mode AI Chat</title>
    <link rel="stylesheet" href="modern-chat-styles.css?v=3.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=SF+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle Menu" 
            onclick="document.getElementById('sidebar').classList.toggle('active');document.getElementById('sidebarOverlay').classList.toggle('active');console.log('Mobile menu toggled!');">
        <span>‚ò∞</span>
    </button>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                                            <div class="brand">
                <img src="companion-icon.svg" alt="Companion AI" class="brand-icon">
                <span class="brand-text">Companion AI</span>
            </div>
                <button class="new-chat-btn" id="newChatBtn">
                    <span class="btn-icon">+</span>
                    <span class="btn-text">New Chat</span>
                </button>
            </div>

            <!-- Search for conversations -->
            <div class="search-conversations">
                <input type="text" 
                       class="conversation-search-input" 
                       id="searchInput"
                       placeholder="Search conversations..."
                       autocomplete="off">
            </div>

            <div class="sidebar-content">
                <div class="chat-history" id="chatHistory">
                    <!-- Chat history will be loaded dynamically -->
                    <div class="history-loading">
                        <div class="loading-spinner"></div>
                        <span>Loading conversations...</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="user-info">
                                                                    <img src="companion-icon.svg" alt="AI" class="user-avatar">
                    <div class="user-details">
                        <span class="user-name">Companion User</span>
                        <span class="user-status">Multi-Engine AI</span>
                    </div>
                </div>
                <div class="footer-links">
                    <a href="download.html" class="footer-link">‚¨á Download Desktop</a>
                    <a href="help.html" class="footer-link">? Help</a>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="chat-info">
                    <h1 class="chat-title">Companion AI</h1>
                    <span class="chat-subtitle">Advanced Multi-Engine AI Assistant</span>
                </div>
                <div class="top-actions">
                    <button class="action-btn" title="Model Settings">
                        <span>‚öô</span>
                    </button>
                    <button class="action-btn" title="Share Chat">
                        <span>‚áß</span>
                    </button>
                    <button class="action-btn" title="Clear Chat" id="clearChatBtn">
                        <span>‚å´</span>
                    </button>
                </div>
            </header>

            <!-- User Menu Tab (Floating, Top Right) -->
            <div class="user-menu" style="position: absolute; top: 18px; right: 32px; z-index: 10001;">
              <button class="user-btn" onclick="toggleMenu()">
                <span class="avatar">AR</span>
                <span class="username">Aryan Rajyaguru</span>
              </button>
              <div class="dropdown" id="dropdown">
                <a href="#">Upgrade plan</a>
                <a href="#">Personalization</a>
                <a href="#">Settings</a>
                <hr />
                <a href="#">Help</a>
                <a href="#" class="logout">Log out</a>
              </div>
            </div>
            <!-- End User Menu Tab -->

            <script>
            function toggleMenu() {
              const menu = document.getElementById("dropdown");
              menu.style.display = menu.style.display === "block" ? "none" : "block";
            }
            // Close on outside click
            if (!window._userMenuListenerAdded) {
              document.addEventListener("click", (e) => {
                if (!e.target.closest(".user-menu")) {
                  document.getElementById("dropdown").style.display = "none";
                }
              });
              window._userMenuListenerAdded = true;
            }
            </script>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome State -->
                <div class="welcome-state" id="welcomeState">
                    <div class="welcome-content">
                        <h1 class="welcome-title">What can I help you with?</h1>
                        
                        <!-- Search Input -->
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <button class="search-btn add-btn" id="addBtnMain" title="Add Files or Connect GitHub">
                                    <span>+</span>
                                </button>
                                <input type="text" 
                                       class="search-input" 
                                       id="chatInput"
                                       placeholder="Message Companion AI..."
                                       autocomplete="off">
                                <div class="search-actions">
                                    <button class="search-btn tools-btn" id="toolsBtn" title="Tools">
                                        <span class="btn-label">Tools</span>
                                    </button>
                                    <button class="search-btn voice-btn" id="voiceBtn" title="Voice Input">
                                        <img src="/SVGs/microphone-svgrepo-com.svg" alt="Voice" class="btn-icon">
                                    </button>
                                    <button class="search-btn send-btn" id="sendBtn" title="Send Message">
                                        <span>‚Üí</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tools Dropdown -->
                            <div class="tools-dropdown" id="toolsDropdown">
                                <div class="tools-header">
                                    <span>Available Tools</span>
                                </div>
                                <div class="tool-toggle-item" data-tool="search">
                                    <div class="tool-info">
                                        <span class="tool-icon">
                                            <img src="/SVGs/search.svg" alt="Search" style="width: 20px; height: 20px;">
                                        </span>
                                        <span class="tool-text">Quick Search</span>
                                        <span class="tool-description">Fast answers using optimized AI models (~20-25s). Perfect for simple questions and quick lookups.</span>
                                    </div>
                                    <label class="tool-toggle">
                                        <input type="checkbox" class="tool-checkbox" data-tool="search">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="tool-toggle-item" data-tool="deepsearch">
                                    <div class="tool-info">
                                        <span class="tool-icon">
                                            <img src="/SVGs/deep search.svg" alt="Deep Search" style="width: 20px; height: 20px;">
                                        </span>
                                        <span class="tool-text">Deep Research</span>
                                        <span class="tool-description">Comprehensive analysis with advanced reasoning (~60-80s). Breaks down complex topics and provides detailed insights.</span>
                                    </div>
                                    <label class="tool-toggle">
                                        <input type="checkbox" class="tool-checkbox" data-tool="deepsearch">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="tool-toggle-item" data-tool="agent">
                                    <div class="tool-info">
                                        <span class="tool-icon">
                                            <img src="/SVGs/Deepthink.svg" alt="Agent Mode" style="width: 20px; height: 20px;">
                                        </span>
                                        <span class="tool-text">Agent Mode</span>
                                        <span class="tool-description">Full autonomous AI assistance (~60-80s). Uses all tools intelligently to solve complex problems and tasks.</span>
                                    </div>
                                    <label class="tool-toggle">
                                        <input type="checkbox" class="tool-checkbox" data-tool="agent">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Main Search Add Dropdown -->
                        <div class="add-dropdown main-search-dropdown" id="addDropdownMain" style="display: none;">
                            <div class="dropdown-header">
                                <span>Add Content</span>
                            </div>
                            <button class="dropdown-item" id="addFileMainBtn">
                                <span class="dropdown-item-icon">üìÑ</span>
                                <span>Upload File</span>
                            </button>
                            <button class="dropdown-item" id="addImageMainBtn">
                                <span class="dropdown-item-icon">üñºÔ∏è</span>
                                <span>Upload Image</span>
                            </button>
                            <button class="dropdown-item" id="connectGithubMainBtn">
                                <span class="dropdown-item-icon">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                    </svg>
                                </span>
                                <span>Connect GitHub Repo</span>
                            </button>
                            <button class="dropdown-item" id="pasteCodeMainBtn">
                                <span class="dropdown-item-icon">üíª</span>
                                <span>Paste Code</span>
                            </button>
                        </div>

                        <!-- Active Tools Display -->
                        <div class="active-tools" id="activeTools" style="display: none;">
                            <div class="active-tools-label">Active tools:</div>
                            <div class="active-tools-list" id="activeToolsList">
                                <!-- Active tools will be shown here -->
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions">
                            <button class="quick-action" data-prompt="Explain quantum computing in simple terms">
                                <span class="action-icon">‚óØ</span>
                                <span class="action-text">Explain quantum computing</span>
                            </button>
                            <button class="quick-action" data-prompt="Write a Python function to sort a list">
                                <span class="action-icon">‚ü®‚ü©</span>
                                <span class="action-text">Python function help</span>
                            </button>
                            <button class="quick-action" data-prompt="What's the meaning of life?">
                                <span class="action-icon">?</span>
                                <span class="action-text">Philosophical question</span>
                            </button>
                            <button class="quick-action" data-prompt="Help me debug this JavaScript code">
                                <span class="action-icon">‚óá</span>
                                <span class="action-text">Debug code</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages" style="display: none;">
                    <!-- Messages will be added here dynamically -->
                </div>
            </div>

            <!-- Input Area (for active chat) -->
            <div class="input-area" id="inputArea" style="display: none;">
                
                <div class="input-container">
                    <div class="input-wrapper">
                        <button class="input-btn add-btn" id="addBtn" title="Add Files, Images, or Connect GitHub">
                            <span>+</span>
                        </button>
                        <textarea class="chat-textarea" 
                                  id="chatTextarea"
                                  placeholder="Message Companion AI..."
                                  rows="1"></textarea>
                        <div class="input-actions">
                            <button class="input-btn tools-btn-chat" id="toolsBtnChat" title="Tools">
                                <span class="btn-label">Tools</span>
                            </button>
                            <button class="input-btn voice-btn" title="Voice Input">
                                <img src="/SVGs/microphone-svgrepo-com.svg" alt="Voice" style="width: 20px; height: 20px;">
                            </button>
                            <button class="input-btn send-btn" id="sendMessageBtn" title="Send">
                                <span>‚Üó</span>
                            </button>
                        </div>
                    </div>
                    <div class="input-footer">
                        <span class="char-count" id="charCount">0 characters</span>
                        <span class="input-hint">Enter to send ‚Ä¢ Shift+Enter for new line</span>
                    </div>
                    
                    <!-- Progress Bar for Tool Operations -->
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-info">
                            <span class="progress-text" id="progressText">Processing with AI tools...</span>
                            <span class="progress-percent" id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>
                    
                    <!-- Add Files Dropdown -->
                    <div class="add-dropdown" id="addDropdown" style="display: none;">
                        <div class="dropdown-header">
                            <span>Add Content</span>
                        </div>
                        <button class="dropdown-item" id="addFileBtn">
                            <span class="dropdown-item-icon">üìÑ</span>
                            <span>Upload File</span>
                        </button>
                        <button class="dropdown-item" id="addImageBtn">
                            <span class="dropdown-item-icon">üñºÔ∏è</span>
                            <span>Upload Image</span>
                        </button>
                        <button class="dropdown-item" id="connectGithubBtn">
                            <span class="dropdown-item-icon">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                                </svg>
                            </span>
                            <span>Connect GitHub Repo</span>
                        </button>
                        <button class="dropdown-item" id="pasteCodeBtn">
                            <span class="dropdown-item-icon">üíª</span>
                            <span>Paste Code</span>
                        </button>
                    </div>
                    
                    <!-- Tools Dropdown for Chat Area -->
                    <div class="tools-dropdown" id="toolsDropdownChat" style="display: none;">
                        <div class="tools-header">
                            <span>Available Tools</span>
                        </div>
                        <div class="tool-toggle-item" data-tool="search">
                            <div class="tool-info">
                                <div class="tool-header">
                                    <span class="tool-icon">
                                        <img src="/SVGs/search.svg" alt="Search" style="width: 20px; height: 20px;">
                                    </span>
                                    <span class="tool-text">Quick Search</span>
                                </div>
                                <span class="tool-description">Fast answers using optimized AI models. Perfect for simple questions and quick lookups.</span>
                                <span class="tool-performance">~20-25 seconds</span>
                            </div>
                            <label class="tool-toggle">
                                <input type="checkbox" class="tool-checkbox-chat" data-tool="search">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="tool-toggle-item" data-tool="deepsearch">
                            <div class="tool-info">
                                <div class="tool-header">
                                    <span class="tool-icon">
                                        <img src="/SVGs/deep search.svg" alt="Deep Search" style="width: 20px; height: 20px;">
                                    </span>
                                    <span class="tool-text">Deep Research</span>
                                </div>
                                <span class="tool-description">Comprehensive analysis with advanced reasoning. Breaks down complex topics and provides detailed insights.</span>
                                <span class="tool-performance">~60-80 seconds</span>
                            </div>
                            <label class="tool-toggle">
                                <input type="checkbox" class="tool-checkbox-chat" data-tool="deepsearch">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="tool-toggle-item" data-tool="agent">
                            <div class="tool-info">
                                <div class="tool-header">
                                    <span class="tool-icon">
                                        <img src="/SVGs/Deepthink.svg" alt="Agent Mode" style="width: 20px; height: 20px;">
                                    </span>
                                    <span class="tool-text">Agent Mode</span>
                                </div>
                                <span class="tool-description">Full autonomous AI assistance. Uses all tools intelligently to solve complex problems and tasks.</span>
                                <span class="tool-performance">~60-80 seconds</span>
                            </div>
                            <label class="tool-toggle">
                                <input type="checkbox" class="tool-checkbox-chat" data-tool="agent">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- GitHub Connection Modal -->
                    <div class="github-modal" id="githubModal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Connect GitHub Repository</h3>
                                <button class="modal-close" id="closeGithubModal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="input-group">
                                    <label for="githubUrl">Repository URL</label>
                                    <input type="text" id="githubUrl" placeholder="https://github.com/username/repository" class="modal-input">
                                </div>
                                <div class="input-group">
                                    <label for="githubToken">Personal Access Token (for push access)</label>
                                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="modal-input">
                                    <small class="input-hint">Required for pushing code. Generate at <a href="https://github.com/settings/tokens" target="_blank">github.com/settings/tokens</a></small>
                                </div>
                                <div class="input-group">
                                    <label for="githubBranch">Branch (optional)</label>
                                    <input type="text" id="githubBranch" placeholder="main" class="modal-input">
                                </div>
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" id="includeReadme"> Include README.md
                                    </label>
                                    <label>
                                        <input type="checkbox" id="includeCode" checked> Include source code
                                    </label>
                                    <label>
                                        <input type="checkbox" id="enablePush"> Enable push functionality
                                    </label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelGithub">Cancel</button>
                                <button class="btn btn-primary" id="connectGithub">Connect Repository</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Voice Status Indicator -->
        <div class="voice-status" id="voiceStatus">
            <div class="voice-status-icon">üé§</div>
            <div class="voice-status-text" id="voiceStatusText">Listening...</div>
        </div>
        
        <!-- File Upload Status Indicator -->
        <div class="file-upload-status" id="fileUploadStatus">
            <div class="file-upload-icon">üìÑ</div>
            <div class="file-upload-text" id="fileUploadText">Uploading file...</div>
            <div class="file-upload-progress">
                <div class="file-upload-bar" id="fileUploadBar"></div>
            </div>
        </div>
        
        <!-- Mobile FAB Button for Tools (shown only on mobile) -->
        <button class="mobile-tools-fab" id="mobileToolsFab" style="display: none;" title="Toggle Tools">
            <span>‚öôÔ∏è</span>
        </button>
        
        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" 
             onclick="document.getElementById('sidebar').classList.remove('active');this.classList.remove('active');"></div>
    </div>

    <script src="voice-chat.js?v=3.3"></script>
    <script src="modern-chat-script.js?v=3.3"></script>
    <script>
        // Authentication check - redirect to login if not authenticated
        (function() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            // Verify token and set auth header for all API calls
            fetch('/api/auth/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.json())
            .then(data => {
                if (!data.user) {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    window.location.href = '/';
                }
            })
            .catch(() => {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user');
                window.location.href = '/';
            });
        })();
    </script>
</body>
</html>